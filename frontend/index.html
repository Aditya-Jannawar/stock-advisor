<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ“Š Stock Advisor Dashboard</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { background-color: #f8fafc; }
    .risk-low { color: #16a34a; font-weight: 600; }       /* green */
    .risk-medium { color: #facc15; font-weight: 600; }    /* yellow */
    .risk-high { color: #dc2626; font-weight: 600; }      /* red */
  </style>
</head>
<body class="min-h-screen flex flex-col items-center p-6">

  <h1 class="text-3xl font-bold text-blue-700 mb-8">ğŸ“ˆ Stock Advisor</h1>

  <!-- Dropdown & Button -->
  <div class="flex flex-wrap justify-center items-center gap-4 mb-8">
    <select id="stockDropdown"
      class="border border-gray-300 rounded-lg px-4 py-2 w-64 shadow-sm focus:ring focus:ring-blue-200">
      <option disabled selected>Loading stocks...</option>
    </select>

    <button id="analyzeBtn"
      class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-5 py-2 rounded-lg shadow">
      Analyze
    </button>
  </div>

  <!-- Loader -->
  <p id="loading" class="hidden text-gray-600">â³ Fetching AI analysis...</p>

  <!-- Cards Section -->
  <div id="cardsContainer" class="grid grid-cols-1 md:grid-cols-3 gap-6 w-full max-w-5xl mb-10 hidden">
    <div class="bg-white shadow-md rounded-xl p-5 border border-gray-200">
      <h2 class="text-lg font-semibold mb-2">Predicted Price</h2>
      <p id="predictedPrice" class="text-2xl font-bold text-blue-600">â‚¹ -</p>
      <p id="tickerName" class="text-gray-500 text-sm mt-1"></p>
    </div>

    <div class="bg-white shadow-md rounded-xl p-5 border border-gray-200">
      <h2 class="text-lg font-semibold mb-2">Risk Level</h2>
      <p id="riskLevel" class="text-xl"></p>
    </div>

    <div class="bg-white shadow-md rounded-xl p-5 border border-gray-200">
      <h2 class="text-lg font-semibold mb-2">AI Suggestion</h2>
      <p id="suggestion" class="text-2xl font-bold">-</p>
    </div>
  </div>

  <!-- Summary Card -->
  <div id="summaryCard" class="hidden bg-white p-6 rounded-xl shadow-md border border-gray-200 w-full max-w-5xl mb-10">
    <h2 class="text-xl font-semibold text-gray-700 mb-3">ğŸ“‹ Summary</h2>
    <p id="summaryText" class="text-gray-700 leading-relaxed"></p>
  </div>

  <!-- Chart Container -->
  <div id="chartContainer" class="hidden bg-white p-6 rounded-xl shadow-md border border-gray-200 w-full max-w-5xl">
    <h2 class="text-xl font-semibold text-gray-700 mb-3">ğŸ“Š Last 30 Days Trend</h2>
    <canvas id="priceChart" height="100"></canvas>
  </div>

  <script>
    let chartInstance = null;

    async function loadStocks() {
      try {
        const res = await fetch("http://127.0.0.1:8000/api/stocks");
        const data = await res.json();
        const dropdown = document.getElementById("stockDropdown");
        dropdown.innerHTML = "";

        const placeholder = document.createElement("option");
        placeholder.text = "Select a stock...";
        placeholder.disabled = true;
        placeholder.selected = true;
        dropdown.add(placeholder);

        data.forEach(stock => {
          const option = document.createElement("option");
          option.value = stock.ticker;
          option.text = `${stock.name} (${stock.ticker})`;
          dropdown.add(option);
        });
      } catch (error) {
        console.error("Error loading stocks:", error);
      }
    }

    async function analyzeStock(e) {
      e.preventDefault();
      const ticker = document.getElementById("stockDropdown").value;
      const loading = document.getElementById("loading");
      const cards = document.getElementById("cardsContainer");
      const summary = document.getElementById("summaryCard");
      const chartBox = document.getElementById("chartContainer");

      loading.classList.remove("hidden");
      cards.classList.add("hidden");
      summary.classList.add("hidden");
      chartBox.classList.add("hidden");

      try {
        const res = await fetch(`http://127.0.0.1:8000/api/analyze/${ticker}`);
        const data = await res.json();
        loading.classList.add("hidden");

        if (!data.data) {
          alert("Error fetching analysis");
          return;
        }

        const stockData = data.data;

        // Show info cards
        document.getElementById("tickerName").textContent = ticker;
        document.getElementById("predictedPrice").textContent =
          "â‚¹" + stockData.predicted_next_day_close.toFixed(2);

        const riskElem = document.getElementById("riskLevel");
        const risk = stockData.risk_level?.toLowerCase() || "unknown";
        riskElem.textContent = stockData.risk_level;

        // risk color
        riskElem.className = risk === "low" ? "risk-low"
                          : risk === "medium" ? "risk-medium"
                          : risk === "high" ? "risk-high"
                          : "text-gray-500";

        const suggestion = stockData.suggestion?.toLowerCase();
        const sugElem = document.getElementById("suggestion");
        sugElem.textContent = stockData.suggestion;
        sugElem.style.color =
          suggestion === "buy" ? "#16a34a" :
          suggestion === "hold" ? "#2563eb" :
          suggestion === "sell" ? "#dc2626" : "#000";

        document.getElementById("summaryText").textContent = stockData.llm_summary;

        cards.classList.remove("hidden");
        summary.classList.remove("hidden");

        // Load 30-day price data for chart
        await loadChart(ticker);
        chartBox.classList.remove("hidden");

      } catch (err) {
        loading.classList.add("hidden");
        alert("âŒ Error: " + err);
      }
    }

    async function loadChart(ticker) {
      const res = await fetch(`https://query1.finance.yahoo.com/v8/finance/chart/${ticker}?interval=1d&range=1mo`);
      const data = await res.json();
      const chartData = data.chart.result[0];
      const timestamps = chartData.timestamp;
      const closes = chartData.indicators.quote[0].close;
      const dates = timestamps.map(ts => new Date(ts * 1000).toLocaleDateString("en-IN", { month: 'short', day: 'numeric' }));

      const ctx = document.getElementById("priceChart").getContext("2d");
      if (chartInstance) chartInstance.destroy();

      chartInstance = new Chart(ctx, {
        type: "line",
        data: {
          labels: dates,
          datasets: [{
            label: "Close Price (â‚¹)",
            data: closes,
            borderColor: "#2563eb",
            backgroundColor: "rgba(37,99,235,0.1)",
            fill: true,
            tension: 0.3
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: { ticks: { color: "#374151" }, grid: { color: "#e5e7eb" }},
            x: { ticks: { color: "#374151" }, grid: { display: false }}
          },
          plugins: {
            legend: { display: false }
          }
        }
      });
    }

    window.onload = () => {
      loadStocks();
      document.getElementById("analyzeBtn").addEventListener("click", analyzeStock);
    };
  </script>
</body>
</html>
